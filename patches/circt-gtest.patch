From 40f3b9094b07644abd87a55cd3ed44c3ec9b7cc9 Mon Sep 17 00:00:00 2001
From: Will Dietz <will.dietz@sifive.com>
Date: Tue, 8 Aug 2023 08:42:24 -0500
Subject: [PATCH] gtest patch

---
 CMakeLists.txt | 70 +++++++++++++++++++++++++++-----------------------
 1 file changed, 38 insertions(+), 32 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index df58aee8c..e91e9872a 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -84,40 +84,46 @@ endif ()
   # Handle unittests when building out-of-tree against an installed version of
   # LLVM/MLIR (not a build tree). Adapted from `llvm/flang/CMakeLists.txt`.
   set(CIRCT_GTEST_AVAILABLE 0)
-  set(UNITTEST_DIR ${LLVM_THIRD_PARTY_DIR}/unittest)
-  if (NOT EXISTS ${UNITTEST_DIR}/googletest/include/gtest/gtest.h)
-    set(UNITTEST_DIR ${CMAKE_CURRENT_SOURCE_DIR}/llvm/third-party/unittest)
-  endif()
-  if (EXISTS ${UNITTEST_DIR}/googletest/include/gtest/gtest.h)
-    if (NOT TARGET llvm_gtest)
-      find_package(Threads)
-      add_llvm_library(llvm_gtest
-        ${UNITTEST_DIR}/googletest/src/gtest-all.cc
-        ${UNITTEST_DIR}/googlemock/src/gmock-all.cc
-        LINK_COMPONENTS Support # llvm::raw_ostream
-        BUILDTREE_ONLY
-      )
-      target_include_directories(llvm_gtest
-        PUBLIC
-        "${UNITTEST_DIR}/googletest/include"
-        "${UNITTEST_DIR}/googlemock/include"
-        PRIVATE
-        "${UNITTEST_DIR}/googletest"
-        "${UNITTEST_DIR}/googlemock"
-      )
-      target_link_libraries(llvm_gtest PUBLIC Threads::Threads)
-      add_llvm_library(llvm_gtest_main
-        ${UNITTEST_DIR}/UnitTestMain/TestMain.cpp
-        LINK_LIBS llvm_gtest
-        LINK_COMPONENTS Support # llvm::cl
-        BUILDTREE_ONLY
-      )
-    endif()
+  if (TARGET llvm_gtest)
+    # Installed gtest, via LLVM_INSTALL_GTEST.  Preferred.
+    message(STATUS "LLVM GTest found, enabling unittests")
     set(CIRCT_GTEST_AVAILABLE 1)
   else()
-    message(WARNING "Skipping unittests since LLVM install does not include \
-      gtest headers and libraries")
-    set(CIRCT_GTEST_AVAILABLE 0)
+    set(UNITTEST_DIR ${LLVM_THIRD_PARTY_DIR}/unittest)
+    if (NOT EXISTS ${UNITTEST_DIR}/googletest/include/gtest/gtest.h)
+      set(UNITTEST_DIR ${CMAKE_CURRENT_SOURCE_DIR}/llvm/third-party/unittest)
+    endif()
+    if (EXISTS ${UNITTEST_DIR}/googletest/include/gtest/gtest.h)
+      if (NOT TARGET llvm_gtest)
+        find_package(Threads)
+        add_llvm_library(llvm_gtest
+          ${UNITTEST_DIR}/googletest/src/gtest-all.cc
+          ${UNITTEST_DIR}/googlemock/src/gmock-all.cc
+          LINK_COMPONENTS Support # llvm::raw_ostream
+          BUILDTREE_ONLY
+        )
+        target_include_directories(llvm_gtest
+          PUBLIC
+          "${UNITTEST_DIR}/googletest/include"
+          "${UNITTEST_DIR}/googlemock/include"
+          PRIVATE
+          "${UNITTEST_DIR}/googletest"
+          "${UNITTEST_DIR}/googlemock"
+        )
+        target_link_libraries(llvm_gtest PUBLIC Threads::Threads)
+        add_llvm_library(llvm_gtest_main
+          ${UNITTEST_DIR}/UnitTestMain/TestMain.cpp
+          LINK_LIBS llvm_gtest
+          LINK_COMPONENTS Support # llvm::cl
+          BUILDTREE_ONLY
+        )
+      endif()
+      set(CIRCT_GTEST_AVAILABLE 1)
+    else()
+      message(WARNING "Skipping unittests since LLVM install does not include \
+        gtest headers and libraries")
+      set(CIRCT_GTEST_AVAILABLE 0)
+    endif()
   endif()
 
 else()
-- 
2.39.1

